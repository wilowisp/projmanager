import{g as U}from"./uuid-Bs_n_vTv.js";function v(l){const[t,e,s]=l.split("-").map(Number);return new Date(t,e-1,s)}function j(l){const t=l.getFullYear(),e=String(l.getMonth()+1).padStart(2,"0"),s=String(l.getDate()).padStart(2,"0");return`${t}-${e}-${s}`}function M(l,t){const e=new Date(l);return e.setDate(e.getDate()+t),e}function F(l,t){const e=v(t).getTime()-v(l).getTime();return Math.max(1,Math.round(e/864e5)+1)}function $(l,t){return Math.round((t.getTime()-l.getTime())/864e5)}function R(){return j(new Date)}const H=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],ot=["January","February","March","April","May","June","July","August","September","October","November","December"];function O(l){const t=new Map;function e(a){const i=(t.get(a)??0)+1;return t.set(a,i),i}function s(a,i){l.filter(c=>c.parentId===a).forEach(c=>{const r=e(a);c.wbs=i?`${i}.${r}`:String(r),s(c.id,c.wbs)})}s(null,"")}function lt(l,t){return l.find(e=>e.wbs===t)}function ct(l){if(l=l.trim(),!l)return null;const t=l.match(/^([\d.]+)(FS|SS|FF|SF)?([+-]\d+)?$/i);return t?{wbs:t[1],type:(t[2]??"FS").toUpperCase(),lag:t[3]?parseInt(t[3],10):0}:null}function rt(l,t){return l.map(e=>{const s=t.find(i=>i.id===e.taskId);if(!s)return null;let a=s.wbs;return e.type!=="FS"&&(a+=e.type),e.lag>0?a+=`+${e.lag}`:e.lag<0&&(a+=`${e.lag}`),a}).filter(Boolean).join(",")}function dt(l,t){const e=new Map;if(l.length===0)return e;const s=v(t),a=new Map,i=new Map;l.forEach(u=>{a.set(u.id,$(s,v(u.startDate))),i.set(u.id,u.duration)});const n=new Map,c=new Map;l.forEach(u=>n.set(u.id,0));for(let u=0;u<l.length;u++)l.forEach(h=>{let b=0;h.predecessors.forEach(p=>{const m=c.get(p.taskId)??0,f=n.get(p.taskId)??0;let S;switch(p.type){case"FS":S=m+p.lag;break;case"SS":S=f+p.lag;break;case"FF":S=m+p.lag-(h.duration-1);break;case"SF":S=f+p.lag-(h.duration-1);break;default:S=m+p.lag}b=Math.max(b,S)}),n.set(h.id,Math.max(n.get(h.id)??0,b)),c.set(h.id,(n.get(h.id)??0)+h.duration-1)});const r=Math.max(...l.map(u=>c.get(u.id)??0)),o=new Map,d=new Map;l.forEach(u=>{o.set(u.id,r),d.set(u.id,r-u.duration+1)});const g=new Map;l.forEach(u=>g.set(u.id,[])),l.forEach(u=>{u.predecessors.forEach(h=>{const b=g.get(h.taskId)??[];b.push({taskId:u.id,dep:h}),g.set(h.taskId,b)})});for(let u=0;u<l.length;u++)[...l].reverse().forEach(h=>{const b=g.get(h.id)??[];b.length===0?o.set(h.id,Math.min(o.get(h.id)??r,r)):b.forEach(({taskId:p,dep:m})=>{const f=d.get(p)??r,S=o.get(p)??r;let w;switch(m.type){case"FS":w=f-m.lag;break;case"SS":w=f-m.lag+h.duration-1;break;case"FF":w=S-m.lag;break;case"SF":w=S-m.lag+h.duration-1;break;default:w=f-m.lag}o.set(h.id,Math.min(o.get(h.id)??r,w))}),d.set(h.id,(o.get(h.id)??r)-h.duration+1)});return l.forEach(u=>{const h=n.get(u.id)??0,b=c.get(u.id)??0,p=d.get(u.id)??0,m=o.get(u.id)??0,f=p-h,S={earlyStart:h,earlyFinish:b,lateStart:p,lateFinish:m,totalFloat:f,isCritical:f<=0};e.set(u.id,S)}),e}const W="pm_github_settings";function N(){const l=localStorage.getItem(W);if(!l)return null;try{return JSON.parse(l)}catch{return null}}function ut(l){localStorage.setItem(W,JSON.stringify(l))}function ht(){localStorage.removeItem(W)}function B(l){let t=window.location.pathname;t.startsWith("/")&&(t=t.slice(1));const e=l.basePath?l.basePath.replace(/^\/|\/$/g,"")+"/":"";return e&&t.startsWith(e)&&(t=t.slice(e.length)),t=t.replace(/\/$/,""),t?`${t}/data.json`:"data.json"}async function pt(l,t){const e=`https://api.github.com/repos/${l.owner}/${l.repo}/contents/${t}?ref=${l.branch}`;try{const s=await fetch(e,{headers:{Authorization:`token ${l.pat}`,Accept:"application/vnd.github+json"}});if(!s.ok)return null;const a=await s.json(),i=atob(a.content.replace(/\n/g,""));return JSON.parse(i)}catch{return null}}async function gt(l,t,e,s="Update project data"){const a=`https://api.github.com/repos/${l.owner}/${l.repo}/contents/${t}`,i={Authorization:`token ${l.pat}`,Accept:"application/vnd.github+json","Content-Type":"application/json"};let n;try{const o=await fetch(`${a}?ref=${l.branch}`,{headers:i});o.ok&&(n=(await o.json()).sha)}catch{}const c=btoa(unescape(encodeURIComponent(e))),r={message:s,content:c,branch:l.branch};n&&(r.sha=n);try{return(await fetch(a,{method:"PUT",headers:i,body:JSON.stringify(r)})).ok}catch{return!1}}async function J(l){const t=`https://api.github.com/repos/${l.owner}/${l.repo}`;try{const e=await fetch(t,{headers:{Authorization:`token ${l.pat}`,Accept:"application/vnd.github+json"}});return e.status===401?"Invalid token (401 Unauthorized)":e.status===404?`Repository "${l.owner}/${l.repo}" not found`:e.ok?null:`GitHub API error: ${e.status}`}catch{return"Network error â€” check your internet connection"}}class bt{constructor(){Object.defineProperty(this,"listeners",{enumerable:!0,configurable:!0,writable:!0,value:[]})}on(t){return this.listeners.push(t),()=>{this.listeners=this.listeners.filter(e=>e!==t)}}emit(t){this.listeners.forEach(e=>e(t))}}function mt(l){const t=R(),e=j(M(v(t),364));return{id:l,name:l,description:"",startDate:t,endDate:e,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),tasks:[],milestones:[],settings:{workingDays:[!1,!0,!0,!0,!0,!0,!1],holidays:[],defaultZoom:"month"}}}class ft extends bt{constructor(t){super(),Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cpm",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"projectId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncStatus",{enumerable:!0,configurable:!0,writable:!0,value:"idle"}),Object.defineProperty(this,"onSyncStatusChange",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"githubFilePath",{enumerable:!0,configurable:!0,writable:!0,value:null}),this.projectId=t,this.loadFromLocalStorage(),this.rebuildCPM()}onSyncStatus(t){this.onSyncStatusChange=t}setSyncStatus(t){var e;this.syncStatus=t,(e=this.onSyncStatusChange)==null||e.call(this,t)}getSyncStatus(){return this.syncStatus}storageKey(){return`pm_project_${this.projectId}`}loadFromLocalStorage(){const t=localStorage.getItem(this.storageKey());if(t)try{this.data=JSON.parse(t);return}catch{}this.data=mt(this.projectId),this.saveLocal()}saveLocal(){this.data.updatedAt=new Date().toISOString(),localStorage.setItem(this.storageKey(),JSON.stringify(this.data)),this.updateLauncherEntry()}updateLauncherEntry(){try{const t="pm_launcher_projects",e=JSON.parse(localStorage.getItem(t)??"[]"),s=e.findIndex(i=>i.id===this.projectId),a={id:this.projectId,name:this.data.name,description:this.data.description??"",updatedAt:this.data.updatedAt,path:`projects/demo/?p=${this.projectId}`};s>=0?e[s]=a:e.push(a),localStorage.setItem(t,JSON.stringify(e))}catch{}}async initialLoad(t=!1){!!!localStorage.getItem(this.storageKey())&&!t&&await this.loadFromStaticUrl("./data.json")}async loadFromStaticUrl(t){try{const e=await fetch(t);if(!e.ok)return;const s=await e.json();this.data=s,this.saveLocal(),this.rebuildCPM(),this.emit({type:"data:load"})}catch{}}async syncNow(){const t=N();if(!t)return!1;this.githubFilePath||(this.githubFilePath=B(t)),this.setSyncStatus("syncing");const e=JSON.stringify(this.data,null,2),s=await gt(t,this.githubFilePath,e);return this.setSyncStatus(s?"ok":"error"),s}async pullFromGitHub(){const t=N();if(!t)return!1;this.githubFilePath||(this.githubFilePath=B(t)),this.setSyncStatus("syncing");const e=await pt(t,this.githubFilePath);if(!e)return this.setSyncStatus("error"),!1;const s=new Date(this.data.updatedAt).getTime();return new Date(e.updatedAt).getTime()>s&&(this.data=e,this.saveLocal(),this.rebuildCPM(),this.emit({type:"data:load"})),this.setSyncStatus("ok"),!0}save(){this.saveLocal()}exportJSON(){return JSON.stringify(this.data,null,2)}importJSON(t){const e=JSON.parse(t);this.data=e,this.save(),this.rebuildCPM(),this.emit({type:"data:load"})}getProject(){return this.data}updateProject(t){Object.assign(this.data,t),this.save(),this.emit({type:"project:update",payload:t})}getSettings(){return this.data.settings}updateSettings(t){Object.assign(this.data.settings,t),this.save()}getTasks(){return this.data.tasks}getVisibleTasks(){const t=this.data.tasks,e=new Set;return t.forEach(s=>{s.collapsed&&this.getDescendants(s.id).forEach(a=>e.add(a.id))}),t.filter(s=>!e.has(s.id))}getTask(t){return this.data.tasks.find(e=>e.id===t)}addTask(t,e){const s=R(),a={id:U(),wbs:"",title:"New Task",assignee:"",status:"not_started",priority:"medium",startDate:s,endDate:j(M(v(s),4)),duration:5,progress:0,predecessors:[],parentId:e??null,collapsed:!1,color:null,notes:"",isMilestone:!1};if(t){const i=this.data.tasks.findIndex(n=>n.id===t);i>=0?this.data.tasks.splice(i+1,0,a):this.data.tasks.push(a)}else this.data.tasks.push(a);return O(this.data.tasks),this.save(),this.rebuildCPM(),this.emit({type:"task:add",payload:a}),a}updateTask(t,e){const s=this.getTask(t);s&&(Object.assign(s,e),e.startDate!==void 0||e.endDate!==void 0?e.endDate===void 0?s.endDate=j(M(v(s.startDate),s.duration-1)):(e.startDate,s.duration=F(s.startDate,s.endDate)):e.duration!==void 0&&(s.endDate=j(M(v(s.startDate),s.duration-1))),this.updateSummaryTask(s.parentId),O(this.data.tasks),this.save(),this.rebuildCPM(),this.emit({type:"task:update",payload:s}))}deleteTask(t){const e=new Set([t,...this.getDescendants(t).map(s=>s.id)]);this.data.tasks.forEach(s=>{s.predecessors=s.predecessors.filter(a=>!e.has(a.taskId))}),this.data.tasks=this.data.tasks.filter(s=>!e.has(s.id)),O(this.data.tasks),this.save(),this.rebuildCPM(),this.emit({type:"task:delete",payload:t})}indentTask(t){const e=this.data.tasks.findIndex(a=>a.id===t);if(e<=0)return;const s=this.data.tasks[e];for(let a=e-1;a>=0;a--)if(this.data.tasks[a].parentId===s.parentId){s.parentId=this.data.tasks[a].id;break}O(this.data.tasks),this.save(),this.emit({type:"task:reorder",payload:this.data.tasks})}outdentTask(t){const e=this.getTask(t);if(!e||!e.parentId)return;const s=this.getTask(e.parentId);e.parentId=(s==null?void 0:s.parentId)??null,O(this.data.tasks),this.save(),this.emit({type:"task:reorder",payload:this.data.tasks})}moveTask(t,e){const s=this.data.tasks.findIndex(i=>i.id===t);if(s<0)return;const[a]=this.data.tasks.splice(s,1);if(e===null)this.data.tasks.unshift(a);else{const i=this.data.tasks.findIndex(n=>n.id===e);this.data.tasks.splice(i+1,0,a)}O(this.data.tasks),this.save(),this.emit({type:"task:reorder",payload:this.data.tasks})}toggleCollapse(t){const e=this.getTask(t);e&&(e.collapsed=!e.collapsed,this.save(),this.emit({type:"task:update",payload:e}))}setPredecessorsFromString(t,e){const s=this.getTask(t);if(!s)return;const a=[];e.split(",").forEach(i=>{const n=ct(i);if(!n)return;const c=lt(this.data.tasks,n.wbs);c&&c.id!==t&&a.push({taskId:c.id,type:n.type,lag:n.lag})}),s.predecessors=a,this.save(),this.rebuildCPM(),this.emit({type:"task:update",payload:s})}getMilestones(){return this.data.milestones}addMilestone(t,e){const s={id:U(),title:t,date:e,color:"#F39C12",taskIds:[]};return this.data.milestones.push(s),this.save(),s}deleteMilestone(t){this.data.milestones=this.data.milestones.filter(e=>e.id!==t),this.save()}getCPM(){return this.cpm}rebuildCPM(){this.cpm=dt(this.data.tasks,this.data.startDate)}isCritical(t){var e;return((e=this.cpm.get(t))==null?void 0:e.isCritical)??!1}getDescendants(t){return this.data.tasks.filter(s=>s.parentId===t).flatMap(s=>[s,...this.getDescendants(s.id)])}getDepth(t){let e=0,s=t;for(;s!=null&&s.parentId;)e++,s=this.getTask(s.parentId);return e}isSummary(t){return this.data.tasks.some(e=>e.parentId===t)}updateSummaryTask(t){if(!t)return;const e=this.getTask(t);if(!e)return;const s=this.data.tasks.filter(r=>r.parentId===t);if(s.length===0)return;const a=s.map(r=>v(r.startDate)),i=s.map(r=>v(r.endDate)),n=new Date(Math.min(...a.map(r=>r.getTime()))),c=new Date(Math.max(...i.map(r=>r.getTime())));e.startDate=j(n),e.endDate=j(c),e.duration=F(e.startDate,e.endDate),e.progress=Math.round(s.reduce((r,o)=>r+o.progress,0)/s.length),this.updateSummaryTask(e.parentId)}getDefaultZoom(){return this.data.settings.defaultZoom}}class _{constructor(t){Object.defineProperty(this,"overlay",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dialog",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"titleEl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"bodyEl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.overlay=document.createElement("div"),this.overlay.className="modal-overlay",this.dialog=document.createElement("div"),this.dialog.className="modal-dialog";const e=document.createElement("div");e.className="modal-header",this.titleEl=document.createElement("h2"),this.titleEl.textContent=t;const s=document.createElement("button");s.className="modal-close",s.textContent="x",s.addEventListener("click",()=>this.close()),e.append(this.titleEl,s),this.bodyEl=document.createElement("div"),this.bodyEl.className="modal-body",this.dialog.append(e,this.bodyEl),this.overlay.append(this.dialog),this.overlay.addEventListener("click",a=>{a.target===this.overlay&&this.close()}),document.addEventListener("keydown",a=>{a.key==="Escape"&&this.isOpen()&&this.close()})}setTitle(t){this.titleEl.textContent=t}setContent(t){this.bodyEl.innerHTML="",this.bodyEl.append(t)}setContentHTML(t){this.bodyEl.innerHTML=t}getBody(){return this.bodyEl}open(){document.body.contains(this.overlay)||document.body.append(this.overlay),requestAnimationFrame(()=>this.overlay.classList.add("open"))}close(){this.overlay.classList.remove("open"),setTimeout(()=>this.overlay.remove(),200)}isOpen(){return document.body.contains(this.overlay)}}function Y(l){return new Promise(t=>{const e=new _("Confirm"),s=document.createElement("div");s.innerHTML=`<p style="margin:0 0 1.5rem">${l}</p>`;const a=document.createElement("div");a.style.cssText="display:flex;gap:.5rem;justify-content:flex-end";const i=document.createElement("button");i.className="btn btn-ghost",i.textContent="Cancel",i.addEventListener("click",()=>{e.close(),t(!1)});const n=document.createElement("button");n.className="btn btn-danger",n.textContent="Delete",n.addEventListener("click",()=>{e.close(),t(!0)}),a.append(i,n),s.append(a),e.setContent(s),e.open()})}function T(l,t="info"){let e=document.getElementById("toast-container");e||(e=document.createElement("div"),e.id="toast-container",document.body.append(e));const s=document.createElement("div");s.className=`toast toast-${t}`,s.textContent=l,e.append(s),requestAnimationFrame(()=>s.classList.add("show")),setTimeout(()=>{s.classList.remove("show"),setTimeout(()=>s.remove(),300)},3e3)}const X={idle:"--",syncing:"..",ok:"OK",error:"!!",offline:"~~"},Z={idle:"GitHub ë¯¸ì„¤ì • â€” Settingsì—ì„œ êµ¬ì„±",syncing:"GitHubì— ì €ìž¥ ì¤‘â€¦",ok:"GitHub Pagesì— ì €ìž¥ë¨",error:"GitHub ë™ê¸°í™” ì‹¤íŒ¨ â€” Settings í™•ì¸",offline:"ì˜¤í”„ë¼ì¸ â€” ë¡œì»¬ì— ì €ìž¥ë¨"};class yt{constructor(t,e){Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"el",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"projectNameEl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"zoomBtns",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncBtn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.el=document.createElement("header"),this.el.className="toolbar",this.render(),this.store.onSyncStatus(s=>this.updateSyncStatus(s))}getElement(){return this.el}render(){const t=this.store.getProject(),e=!!N();this.el.innerHTML=`
      <div class="toolbar-left">
        <div class="project-name-wrap">
          <span class="project-icon">ðŸ“‹</span>
          <h1 class="project-name" contenteditable="true" spellcheck="false">${vt(t.name)}</h1>
        </div>
      </div>
      <div class="toolbar-center">
        <button class="btn btn-primary" id="tb-add-task">+ Task</button>
        <button class="btn btn-ghost" id="tb-add-milestone">+ Milestone</button>
        <div class="separator"></div>
        <div class="zoom-group" role="group" aria-label="Zoom level">
          <button class="zoom-btn" data-zoom="day">Day</button>
          <button class="zoom-btn" data-zoom="week">Week</button>
          <button class="zoom-btn zoom-btn--active" data-zoom="month">Month</button>
          <button class="zoom-btn" data-zoom="quarter">Quarter</button>
        </div>
        <div class="separator"></div>
        <button class="btn btn-ghost" id="tb-today">Today</button>
        <label class="toggle-label">
          <input type="checkbox" id="tb-critical" />
          <span>Critical</span>
        </label>
      </div>
      <div class="toolbar-right">
        <button class="sync-btn ${e?"":"sync-unconfigured"}" id="tb-sync"
          title="${Z[this.store.getSyncStatus()]}">
          ${X[this.store.getSyncStatus()]} GitHub
        </button>
        <div class="separator"></div>
        <button class="btn btn-ghost" id="tb-share" title="ì´ í”„ë¡œì íŠ¸ë¥¼ JSONìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°">Share</button>
        <button class="btn btn-ghost" id="tb-import" title="JSONì—ì„œ ê°€ì ¸ì˜¤ê¸°">Import</button>
        <button class="btn btn-ghost" id="tb-settings" title="Settings">Settings</button>
        <a class="btn btn-ghost" href="/projmanager/" title="ëª¨ë“  í”„ë¡œì íŠ¸">All</a>
      </div>
    `,this.projectNameEl=this.el.querySelector(".project-name"),this.projectNameEl.addEventListener("blur",()=>{var a;const s=((a=this.projectNameEl.textContent)==null?void 0:a.trim())??"";s&&s!==this.store.getProject().name&&(this.store.updateProject({name:s}),document.title=s)}),this.projectNameEl.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),this.projectNameEl.blur())}),this.el.querySelector("#tb-add-task").addEventListener("click",()=>this.events.onAddTask()),this.el.querySelector("#tb-add-milestone").addEventListener("click",()=>this.events.onAddMilestone()),this.el.querySelector("#tb-today").addEventListener("click",()=>this.events.onScrollToToday()),this.el.querySelector("#tb-settings").addEventListener("click",()=>this.events.onOpenSettings()),this.zoomBtns=this.el.querySelectorAll(".zoom-btn"),this.zoomBtns.forEach(s=>{s.addEventListener("click",()=>{this.zoomBtns.forEach(a=>a.classList.remove("zoom-btn--active")),s.classList.add("zoom-btn--active"),this.events.onZoomChange(s.dataset.zoom)})}),this.el.querySelector("#tb-critical").addEventListener("change",s=>{this.events.onToggleCriticalPath(s.target.checked)}),this.syncBtn=this.el.querySelector("#tb-sync"),this.syncBtn.addEventListener("click",async()=>{if(!N()){this.events.onOpenSettings();return}await this.store.syncNow()?T("GitHub Pagesì— ì €ìž¥ë¨","success"):T("GitHub ë™ê¸°í™” ì‹¤íŒ¨ â€” Settings í™•ì¸","error")}),this.el.querySelector("#tb-share").addEventListener("click",()=>{const s=this.store.exportJSON(),a=new Blob([s],{type:"application/json"}),i=document.createElement("a");i.href=URL.createObjectURL(a),i.download=`${this.store.getProject().id}-${St()}.json`,i.click(),URL.revokeObjectURL(i.href),T("ë‚´ë³´ë‚´ê¸° ì™„ë£Œ","success")}),this.el.querySelector("#tb-import").addEventListener("click",()=>{const s=document.createElement("input");s.type="file",s.accept=".json",s.addEventListener("change",()=>{var n;const a=(n=s.files)==null?void 0:n[0];if(!a)return;const i=new FileReader;i.onload=()=>{try{this.store.importJSON(i.result),T("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ","success")}catch{T("ì˜¬ë°”ë¥¸ JSON íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤","error")}},i.readAsText(a)}),s.click()})}updateSyncStatus(t){this.syncBtn&&(this.syncBtn.textContent=`${X[t]} GitHub`,this.syncBtn.title=Z[t],this.syncBtn.className=`sync-btn sync-${t}`,t==="syncing"?this.syncBtn.classList.add("spin"):this.syncBtn.classList.remove("spin"))}setZoom(t){var e;(e=this.zoomBtns)==null||e.forEach(s=>{s.classList.toggle("zoom-btn--active",s.dataset.zoom===t)})}syncProjectName(){this.projectNameEl.textContent=this.store.getProject().name}}function vt(l){return l.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function St(){return new Date().toISOString().split("T")[0]}class wt{constructor(t,e){Object.defineProperty(this,"el",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"year",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"month",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"selectedDate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onSelectCb",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"closeHandler",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyHandler",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.selectedDate=t||"",this.onSelectCb=e;const s=t?v(t):new Date;this.year=s.getFullYear(),this.month=s.getMonth(),this.el=document.createElement("div"),this.el.className="datepicker-popup",this.el.addEventListener("mousedown",a=>a.stopPropagation())}show(t){this.buildUI(),document.body.append(this.el),this.position(t),this.closeHandler=e=>{this.el.contains(e.target)||this.close()},this.keyHandler=e=>{e.key==="Escape"&&this.close()},setTimeout(()=>{document.addEventListener("mousedown",this.closeHandler),document.addEventListener("keydown",this.keyHandler)},0)}close(){this.el.remove(),document.removeEventListener("mousedown",this.closeHandler),document.removeEventListener("keydown",this.keyHandler)}position(t){const e=t.getBoundingClientRect(),s=280,a=e.bottom+window.scrollY+4,i=e.left+window.scrollX,n=i+240-window.innerWidth,c=a+s-window.innerHeight-window.scrollY;this.el.style.top=`${c>0?e.top+window.scrollY-s-4:a}px`,this.el.style.left=`${n>0?i-n-8:i}px`}buildUI(){const t=kt(new Date),e=new Date(this.year,this.month,1).getDay(),s=new Date(this.year,this.month+1,0).getDate();this.el.innerHTML=`
      <div class="dp-input-row">
        <input class="dp-text-input form-input" type="text"
          value="${this.selectedDate}" placeholder="YYYY-MM-DD" />
      </div>
      <div class="dp-nav-row">
        <button class="dp-nav-btn" data-dir="-1">&lt;</button>
        <span class="dp-month-label">${ot[this.month]} ${this.year}</span>
        <button class="dp-nav-btn" data-dir="1">&gt;</button>
      </div>
      <div class="dp-weekdays">
        <span>Su</span><span>Mo</span><span>Tu</span><span>We</span>
        <span>Th</span><span>Fr</span><span>Sa</span>
      </div>
      <div class="dp-days">
        ${Array.from({length:e},()=>"<span></span>").join("")}
        ${Array.from({length:s},(n,c)=>{const r=c+1,o=`${this.year}-${String(this.month+1).padStart(2,"0")}-${String(r).padStart(2,"0")}`,d=o===t,g=o===this.selectedDate;return`<button class="dp-day${d?" dp-today":""}${g?" dp-selected":""}"
            data-date="${o}">${r}</button>`}).join("")}
      </div>
      <div class="dp-footer">
        <button class="dp-today-btn">Today</button>
        <button class="dp-clear-btn">Clear</button>
      </div>
    `;const a=this.el.querySelector(".dp-text-input"),i=()=>{const n=a.value.trim();/^\d{4}-\d{2}-\d{2}$/.test(n)&&(this.selectedDate=n,this.onSelectCb(n),this.close())};a.addEventListener("keydown",n=>{n.key==="Enter"&&i()}),a.addEventListener("blur",i),a.addEventListener("mousedown",n=>n.stopPropagation()),this.el.querySelectorAll(".dp-nav-btn").forEach(n=>{n.addEventListener("click",()=>{this.month+=parseInt(n.dataset.dir),this.month<0&&(this.month=11,this.year--),this.month>11&&(this.month=0,this.year++);const c=this.el.parentElement;this.buildUI(),c&&this.position(c)})}),this.el.querySelectorAll(".dp-day").forEach(n=>{n.addEventListener("click",()=>{this.selectedDate=n.dataset.date,this.onSelectCb(this.selectedDate),this.close()})}),this.el.querySelector(".dp-today-btn").addEventListener("click",()=>{this.selectedDate=t,this.onSelectCb(t),this.close()}),this.el.querySelector(".dp-clear-btn").addEventListener("click",()=>{this.onSelectCb(""),this.close()})}}function kt(l){return`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}-${String(l.getDate()).padStart(2,"0")}`}function nt(l,t){const e=t.getBoundingClientRect(),s=320,a=Math.min(e.left,window.innerWidth-300),i=e.bottom+s+8<window.innerHeight;l.style.top=i?`${e.bottom+4}px`:`${e.top-s-4}px`,l.style.left=`${Math.max(4,a)}px`}function it(l,t){const e=a=>{l.contains(a.target)||t()},s=a=>{a.key==="Escape"&&t()};return setTimeout(()=>{document.addEventListener("mousedown",e),document.addEventListener("keydown",s)},0),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",s)}}class Et{constructor(){Object.defineProperty(this,"el",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cleanup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.el=document.createElement("div"),this.el.className="task-selector-popup",this.el.addEventListener("mousedown",t=>t.stopPropagation())}show(t,e,s,a){const i=e.getVisibleTasks().filter(o=>o.id!==s),n=e.getTask(s),c=new Map(n.predecessors.map(o=>[o.taskId,o]));this.el.innerHTML=`
      <div class="ts-header">
        <span class="ts-title">Select Predecessors</span>
        <button class="ts-clear btn btn-ghost" style="font-size:11px;padding:2px 6px">Clear all</button>
      </div>
      <div class="ts-list">
        ${i.map(o=>{const d=c.get(o.id),g=d?"checked":"",u=(d==null?void 0:d.type)??"FS",h=(d==null?void 0:d.lag)??0;return`
            <div class="ts-row${d?" ts-row-active":""}" data-id="${o.id}">
              <input type="checkbox" class="ts-check" data-id="${o.id}" ${g} />
              <span class="ts-wbs">${o.wbs}</span>
              <span class="ts-name">${q(o.title)}</span>
              <select class="ts-type" data-id="${o.id}" ${d?"":"disabled"}>
                ${["FS","SS","FF","SF"].map(b=>`<option${b===u?" selected":""}>${b}</option>`).join("")}
              </select>
              <input type="number" class="ts-lag" data-id="${o.id}"
                value="${h}" min="-99" max="99" style="width:44px"
                ${d?"":"disabled"} />
              <span class="ts-lag-label">d</span>
            </div>
          `}).join("")}
      </div>
    `,document.body.append(this.el),nt(this.el,t);const r=()=>{const o=[];this.el.querySelectorAll(".ts-check:checked").forEach(d=>{var m,f;const g=d.dataset.id,u=e.getTask(g);if(!u)return;const h=((m=this.el.querySelector(`.ts-type[data-id="${g}"]`))==null?void 0:m.value)??"FS",b=parseInt(((f=this.el.querySelector(`.ts-lag[data-id="${g}"]`))==null?void 0:f.value)??"0",10);let p=u.wbs;h!=="FS"&&(p+=h),b>0?p+=`+${b}`:b<0&&(p+=`${b}`),o.push(p)}),a(o.join(","))};this.el.querySelectorAll(".ts-check").forEach(o=>{o.addEventListener("change",()=>{const d=o.dataset.id,g=this.el.querySelector(`.ts-row[data-id="${d}"]`),u=this.el.querySelector(`.ts-type[data-id="${d}"]`),h=this.el.querySelector(`.ts-lag[data-id="${d}"]`);u.disabled=!o.checked,h.disabled=!o.checked,g.classList.toggle("ts-row-active",o.checked),r()})}),this.el.querySelectorAll(".ts-type").forEach(o=>{o.addEventListener("change",r)}),this.el.querySelectorAll(".ts-lag").forEach(o=>{o.addEventListener("input",r)}),this.el.querySelector(".ts-clear").addEventListener("click",()=>{this.el.querySelectorAll(".ts-check").forEach(o=>{o.checked=!1}),this.el.querySelectorAll(".ts-type").forEach(o=>{o.disabled=!0}),this.el.querySelectorAll(".ts-lag").forEach(o=>{o.disabled=!0}),this.el.querySelectorAll(".ts-row").forEach(o=>o.classList.remove("ts-row-active")),a("")}),this.cleanup=it(this.el,()=>this.close())}close(){var t;this.el.remove(),(t=this.cleanup)==null||t.call(this)}}class $t{constructor(){Object.defineProperty(this,"el",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cleanup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.el=document.createElement("div"),this.el.className="task-selector-popup assignee-popup",this.el.addEventListener("mousedown",t=>t.stopPropagation())}show(t,e,s,a){const i=new Set,n=[];e.getTasks().forEach(r=>{r.assignee&&!i.has(r.assignee)&&(i.add(r.assignee),n.push(r.assignee))}),this.el.innerHTML=`
      <div class="ts-header">
        <span class="ts-title">Assignee</span>
      </div>
      <div class="ts-input-row">
        <input class="ts-text-input form-input" type="text"
          value="${q(s)}" placeholder="Type nameâ€¦" />
      </div>
      <div class="ts-list">
        ${n.length===0?'<span class="ts-empty">No assignees yet</span>':""}
        ${n.map(r=>`
          <div class="ts-row${r===s?" ts-row-active":""}" data-name="${q(r)}">
            <span class="ts-avatar">${r.charAt(0).toUpperCase()}</span>
            <span class="ts-name">${q(r)}</span>
          </div>`).join("")}
      </div>
    `,document.body.append(this.el),nt(this.el,t);const c=this.el.querySelector(".ts-text-input");c.focus(),c.select(),c.addEventListener("keydown",r=>{r.key==="Enter"&&(a(c.value.trim()),this.close())}),this.el.querySelectorAll(".ts-row").forEach(r=>{r.addEventListener("click",()=>{a(r.dataset.name),this.close()})}),this.cleanup=it(this.el,()=>{const r=c.value.trim();r!==s&&a(r),this.close()})}close(){var t;this.el.remove(),(t=this.cleanup)==null||t.call(this)}}function q(l){return l.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}const Lt={not_started:"[ ]",in_progress:"[>]",done:"[v]",cancelled:"[x]",on_hold:"[=]"},Dt={low:"#6c757d",medium:"#0d6efd",high:"#fd7e14",critical:"#dc3545"},K={instance:null},V=new Et,Q=new $t;class Pt{constructor(t){Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"el",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tbody",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"selectedId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"onSelectCallback",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"dragSrc",{enumerable:!0,configurable:!0,writable:!0,value:null}),this.el=document.createElement("div"),this.el.className="task-table-wrap",this.build(),this.listenStore()}getElement(){return this.el}onSelect(t){this.onSelectCallback=t}setSelected(t){this.selectedId=t,this.el.querySelectorAll(".task-row").forEach(e=>e.classList.toggle("selected",e.dataset.id===t))}build(){this.el.innerHTML=`
      <table class="task-table" cellspacing="0">
        <thead>
          <tr>
            <th class="col-wbs">WBS</th>
            <th class="col-name">Task Name</th>
            <th class="col-dur">Dur</th>
            <th class="col-start">Start</th>
            <th class="col-end">End</th>
            <th class="col-pct">%</th>
            <th class="col-pred">Pred</th>
            <th class="col-assign">Assignee</th>
            <th class="col-status">St</th>
            <th class="col-actions"></th>
          </tr>
        </thead>
        <tbody class="task-tbody"></tbody>
      </table>
    `,this.tbody=this.el.querySelector(".task-tbody"),this.renderRows(),this.setupKeyboard()}renderRows(){const t=this.store.getVisibleTasks();this.tbody.innerHTML="",t.forEach(e=>this.tbody.append(this.buildRow(e))),this.restoreSelection()}buildRow(t){var o,d,g,u,h,b;const e=this.store.getCPM().get(t.id),s=(e==null?void 0:e.isCritical)??!1,a=this.store.isSummary(t.id),i=this.store.getDepth(t),n=rt(t.predecessors,this.store.getTasks()),c=i*18+4,r=document.createElement("tr");return r.className=`task-row${s?" critical":""}${a?" summary":""}${t.isMilestone?" milestone-row":""}`,r.dataset.id=t.id,r.draggable=!0,r.innerHTML=`
      <td class="col-wbs"><span class="wbs-num">${t.wbs}</span></td>
      <td class="col-name">
        <div class="task-name-cell" style="padding-left:${c}px">
          ${a?`<button class="collapse-btn" data-id="${t.id}">${t.collapsed?"+":"-"}</button>`:'<span class="collapse-spacer"></span>'}
          ${t.isMilestone?'<span class="milestone-icon">[M]</span>':""}
          <span class="priority-dot" style="background:${Dt[t.priority]}" title="${t.priority}"></span>
          <span class="task-title editable" data-field="title">${tt(t.title)}</span>
        </div>
      </td>
      <td class="col-dur"><span class="editable" data-field="duration">${t.duration}</span></td>
      <td class="col-start">
        <span class="editable date-cell" data-field="startDate">${t.startDate}</span>
      </td>
      <td class="col-end">
        <span class="editable date-cell" data-field="endDate">${t.endDate}</span>
      </td>
      <td class="col-pct">
        <div class="progress-cell">
          <div class="progress-bar-mini" style="width:${t.progress}%"></div>
          <span class="editable" data-field="progress">${t.progress}</span>
        </div>
      </td>
      <td class="col-pred">
        <span class="editable picker-cell pred-cell" data-field="predecessors">${n||"â€”"}</span>
      </td>
      <td class="col-assign">
        <span class="editable picker-cell" data-field="assignee">${tt(t.assignee)||"â€”"}</span>
      </td>
      <td class="col-status">
        <button class="status-btn" data-id="${t.id}" title="${t.status}">${Lt[t.status]}</button>
      </td>
      <td class="col-actions">
        <button class="act-btn add-after" data-id="${t.id}" title="Add task below">+</button>
        <button class="act-btn delete-btn" data-id="${t.id}" title="Delete">x</button>
        <button class="act-btn indent-btn" data-id="${t.id}" title="Indent">&gt;</button>
        <button class="act-btn outdent-btn" data-id="${t.id}" title="Outdent">&lt;</button>
      </td>
    `,r.addEventListener("click",p=>{p.target.closest("button,.editable")||this.selectRow(t.id)}),r.querySelectorAll(".editable").forEach(p=>{const m=p.dataset.field;m==="startDate"||m==="endDate"?p.addEventListener("click",f=>{f.stopPropagation(),this.selectRow(t.id),this.openDatePicker(p,t,m)}):m==="predecessors"?p.addEventListener("click",f=>{f.stopPropagation(),this.selectRow(t.id),this.openPredSelector(p,t)}):m==="assignee"?p.addEventListener("click",f=>{f.stopPropagation(),this.selectRow(t.id),this.openAssigneeSelector(p,t)}):(p.addEventListener("dblclick",()=>this.startEdit(p,t)),p.addEventListener("keydown",f=>{f.key==="F2"&&(f.preventDefault(),this.startEdit(p,t))}))}),(o=r.querySelector(".add-after"))==null||o.addEventListener("click",p=>{p.stopPropagation(),this.store.addTask(t.id)}),(d=r.querySelector(".delete-btn"))==null||d.addEventListener("click",async p=>{p.stopPropagation(),await Y(`Delete "${t.title}"?`)&&this.store.deleteTask(t.id)}),(g=r.querySelector(".indent-btn"))==null||g.addEventListener("click",p=>{p.stopPropagation(),this.store.indentTask(t.id)}),(u=r.querySelector(".outdent-btn"))==null||u.addEventListener("click",p=>{p.stopPropagation(),this.store.outdentTask(t.id)}),(h=r.querySelector(".collapse-btn"))==null||h.addEventListener("click",p=>{p.stopPropagation(),this.store.toggleCollapse(t.id)}),(b=r.querySelector(".status-btn"))==null||b.addEventListener("click",p=>{p.stopPropagation();const m=["not_started","in_progress","done","on_hold","cancelled"],f=m[(m.indexOf(t.status)+1)%m.length];this.store.updateTask(t.id,{status:f})}),r.addEventListener("dragstart",()=>{this.dragSrc=t.id,r.classList.add("dragging")}),r.addEventListener("dragend",()=>r.classList.remove("dragging")),r.addEventListener("dragover",p=>p.preventDefault()),r.addEventListener("drop",p=>{p.preventDefault(),this.dragSrc&&this.dragSrc!==t.id&&(this.store.moveTask(this.dragSrc,t.id),this.dragSrc=null)}),r}openDatePicker(t,e,s){var n;(n=K.instance)==null||n.close();const a=s==="startDate"?e.startDate:e.endDate,i=new wt(a,c=>{c&&this.store.updateTask(e.id,{[s]:c})});K.instance=i,i.show(t)}openPredSelector(t,e){V.close(),V.show(t,this.store,e.id,s=>{this.store.setPredecessorsFromString(e.id,s)})}openAssigneeSelector(t,e){Q.close(),Q.show(t,this.store,e.assignee,s=>{this.store.updateTask(e.id,{assignee:s})})}startEdit(t,e){var r;if(t.dataset.editing)return;t.dataset.editing="1";const s=t.dataset.field,a=((r=t.textContent)==null?void 0:r.trim())??"";t.classList.add("editing");const i=document.createElement("input");i.type="text",i.className="cell-input",i.value=a,t.textContent="",t.append(i),i.select();const n=()=>{delete t.dataset.editing,t.classList.remove("editing");const o=i.value.trim();o!==a&&this.commitEdit(e,s,o)},c=()=>{delete t.dataset.editing,t.classList.remove("editing"),t.textContent=a};i.addEventListener("blur",n),i.addEventListener("keydown",o=>{var d;if(o.key==="Enter"&&(o.preventDefault(),i.blur()),o.key==="Escape"&&(o.preventDefault(),i.removeEventListener("blur",n),c()),o.key==="Tab"){o.preventDefault(),i.blur();const g=[...t.closest("tr").querySelectorAll(".editable:not(.date-cell):not(.picker-cell)")],u=g.indexOf(t);(d=g[o.shiftKey?u-1:u+1])==null||d.dispatchEvent(new MouseEvent("dblclick"))}})}commitEdit(t,e,s){if(e==="duration"){const a=parseInt(s,10);!isNaN(a)&&a>=1&&this.store.updateTask(t.id,{duration:a})}else if(e==="progress"){const a=Math.min(100,Math.max(0,parseInt(s,10)));isNaN(a)||this.store.updateTask(t.id,{progress:a})}else this.store.updateTask(t.id,{[e]:s})}listenStore(){this.store.on(t=>{["task:add","task:update","task:delete","task:reorder","data:load"].includes(t.type)&&this.renderRows()})}selectRow(t){var e;this.selectedId=t,this.restoreSelection(),(e=this.onSelectCallback)==null||e.call(this,t)}restoreSelection(){this.el.querySelectorAll(".task-row").forEach(t=>t.classList.toggle("selected",t.dataset.id===this.selectedId))}setupKeyboard(){document.addEventListener("keydown",t=>{if(!this.selectedId)return;const e=document.activeElement;if(!(e&&(e.tagName==="INPUT"||e.tagName==="SELECT"||e.contentEditable==="true"))){if(t.key==="Delete"||t.key==="Backspace"){const s=this.store.getTask(this.selectedId);s&&Y(`Delete "${s.title}"?`).then(a=>{a&&this.store.deleteTask(this.selectedId)})}t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),this.store.addTask(this.selectedId))}})}}function tt(l){return l.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}const D=36,x=20,et=(D-x)/2,z=46,st=9,Tt=12,C={day:38,week:12,month:3.5,quarter:1.2};class Mt{constructor(t){Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"el",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"svg",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"headerSvg",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"selectedId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"zoom",{enumerable:!0,configurable:!0,writable:!0,value:"month"}),Object.defineProperty(this,"showCritical",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"onSelectCallback",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"dragTask",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"dragMode",{enumerable:!0,configurable:!0,writable:!0,value:"move"}),Object.defineProperty(this,"dragStartX",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"dragOrigStart",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"dragOrigDur",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"linkDrawSrc",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"linkLine",{enumerable:!0,configurable:!0,writable:!0,value:null}),this.zoom=t.getDefaultZoom(),this.el=document.createElement("div"),this.el.className="gantt-wrap",this.buildSkeleton(),this.render(),this.listenStore()}getElement(){return this.el}onSelect(t){this.onSelectCallback=t}setSelected(t){this.selectedId=t,this.svg.querySelectorAll(".task-bar").forEach(e=>{e.classList.toggle("bar-selected",e.dataset.id===t)})}setZoom(t){this.zoom=t,this.render()}setShowCritical(t){this.showCritical=t,this.render()}scrollToToday(){const t=this.el.querySelector(".gantt-body-wrap");if(!t)return;const e=v(this.store.getProject().startDate),a=$(e,new Date),i=C[this.zoom],n=a*i-t.clientWidth/2;t.scrollLeft=Math.max(0,n)}buildSkeleton(){this.el.innerHTML=`
      <div class="gantt-header-wrap">
        <svg class="gantt-header-svg"></svg>
      </div>
      <div class="gantt-body-wrap">
        <svg class="gantt-body-svg"></svg>
      </div>
    `,this.headerSvg=this.el.querySelector(".gantt-header-svg"),this.svg=this.el.querySelector(".gantt-body-svg");const t=this.el.querySelector(".gantt-body-wrap");t.addEventListener("scroll",()=>{const e=this.el.querySelector(".gantt-header-wrap");e.scrollLeft=t.scrollLeft}),this.setupDrag()}render(){const t=this.store.getVisibleTasks(),e=this.store.getProject(),s=v(e.startDate),a=v(e.endDate),i=C[this.zoom],n=Math.max($(s,a)+30,30),c=n*i,r=t.length*D;this.setSvgSize(this.headerSvg,c,z),this.setSvgSize(this.svg,c,r||D),this.renderHeader(s,n,i),this.renderBody(t,s,n,i,c,r)}renderHeader(t,e,s){at(this.headerSvg);const i=document.createElementNS("http://www.w3.org/2000/svg","rect");i.setAttribute("width",String(this.headerSvg.width.baseVal.value)),i.setAttribute("height",String(z)),i.setAttribute("fill","var(--gantt-header-bg)"),this.headerSvg.append(i),this.zoom==="day"?this.renderDayHeader(t,e,s):this.zoom==="week"?this.renderWeekHeader(t,e,s):this.renderMonthHeader(t,e,s)}renderMonthHeader(t,e,s){const a="http://www.w3.org/2000/svg";let i=0;const n=new Date(t);n.setDate(1);let c=-1;for(;i<e*s+s*31;){const r=n.getFullYear(),o=n.getMonth(),g=new Date(r,o+1,0).getDate()*s,h=$(t,n)*s;if(h>e*s+100)break;if(r!==c){const m=A(a,String(r),h+2,13,"gantt-hdr-year");this.headerSvg.append(m),c=r}const b=document.createElementNS(a,"rect");P(b,{x:String(h),y:"22",width:String(g-1),height:"24",fill:o%2===0?"var(--gantt-month-a)":"var(--gantt-month-b)",rx:"2"}),this.headerSvg.append(b);const p=A(a,H[o],h+g/2,38,"gantt-hdr-month","middle");this.headerSvg.append(p),i=h+g,n.setMonth(n.getMonth()+1)}}renderWeekHeader(t,e,s){const a="http://www.w3.org/2000/svg";let i=-1;for(let n=0;n<e+7;n++){const c=M(t,n),r=c.getDay(),o=n*s;if(c.getMonth()!==i){const d=A(a,`${H[c.getMonth()]} ${c.getFullYear()}`,o+2,13,"gantt-hdr-year");this.headerSvg.append(d),i=c.getMonth();const g=document.createElementNS(a,"line");P(g,{x1:String(o),y1:"0",x2:String(o),y2:String(z),stroke:"var(--gantt-grid)","stroke-width":"1"}),this.headerSvg.append(g)}if(r===1){const d=document.createElementNS(a,"rect");P(d,{x:String(o),y:"22",width:String(7*s-1),height:"24",fill:"var(--gantt-month-a)",rx:"2"}),this.headerSvg.append(d);const g=A(a,`W${jt(c)}`,o+2,38,"gantt-hdr-month");this.headerSvg.append(g)}}}renderDayHeader(t,e,s){const a="http://www.w3.org/2000/svg";let i=-1;for(let n=0;n<e;n++){const c=M(t,n),r=n*s,o=c.getDay(),d=o===0||o===6;if(c.getMonth()!==i){const h=A(a,`${H[c.getMonth()]} ${c.getFullYear()}`,r+2,13,"gantt-hdr-year");this.headerSvg.append(h),i=c.getMonth()}const g=document.createElementNS(a,"rect");P(g,{x:String(r),y:"22",width:String(s-1),height:"24",fill:d?"var(--gantt-weekend)":"var(--gantt-month-a)",rx:"1"}),this.headerSvg.append(g);const u=A(a,String(c.getDate()),r+s/2,38,"gantt-hdr-day","middle");this.headerSvg.append(u)}}renderBody(t,e,s,a,i,n){at(this.svg);const c="http://www.w3.org/2000/svg",r=document.createElementNS(c,"defs");r.innerHTML=`
      <marker id="arrow" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
        <path d="M0,0 L0,6 L6,3 z" fill="var(--dep-arrow)"/>
      </marker>
      <marker id="arrow-crit" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
        <path d="M0,0 L0,6 L6,3 z" fill="var(--dep-arrow-crit)"/>
      </marker>
      <marker id="arrow-draw" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
        <path d="M0,0 L0,6 L6,3 z" fill="var(--accent)"/>
      </marker>
    `,this.svg.append(r),t.forEach((d,g)=>{const u=document.createElementNS(c,"rect");P(u,{x:"0",y:String(g*D),width:String(i),height:String(D),fill:g%2===0?"var(--gantt-row-a)":"var(--gantt-row-b)"}),this.svg.append(u)}),this.renderVerticalGrid(e,s,a,n);const o=$(e,new Date);if(o>=0&&o<=s){const d=document.createElementNS(c,"line");P(d,{x1:String(o*a),y1:"0",x2:String(o*a),y2:String(n),stroke:"var(--today-line)","stroke-width":"2","stroke-dasharray":"4,3"}),this.svg.append(d)}t.forEach((d,g)=>this.renderBar(d,g,e,a)),t.forEach(d=>{d.predecessors.forEach(g=>{const u=t.find(p=>p.id===g.taskId);if(!u)return;const h=t.indexOf(u),b=t.indexOf(d);h<0||b<0||this.renderArrow(u,h,d,b,g.type,g.lag,e,a)})}),this.store.getMilestones().forEach(d=>{const g=$(e,v(d.date))*a,u=document.createElementNS(c,"polygon"),h=n+14,b=st;u.setAttribute("points",`${g},${h-b} ${g+b},${h} ${g},${h+b} ${g-b},${h}`),u.setAttribute("fill",d.color),u.setAttribute("class","milestone-diamond");const p=document.createElementNS(c,"title");p.textContent=d.title,u.append(p),this.svg.append(u)}),this.store.getMilestones().length>0&&this.setSvgSize(this.svg,i,n+30)}renderVerticalGrid(t,e,s,a){const i="http://www.w3.org/2000/svg",n=new Date(t);for(n.setDate(1);$(t,n)<e+31;){const c=$(t,n)*s;if(c>=0){const r=document.createElementNS(i,"line");P(r,{x1:String(c),y1:"0",x2:String(c),y2:String(a),stroke:"var(--gantt-grid)","stroke-width":"1"}),this.svg.append(r)}n.setMonth(n.getMonth()+1)}}renderBar(t,e,s,a){const i="http://www.w3.org/2000/svg",n=this.store.getCPM().get(t.id),c=this.showCritical&&((n==null?void 0:n.isCritical)??!1),r=this.store.isSummary(t.id),o=t.id===this.selectedId,d=$(s,v(t.startDate))*a,g=Math.max(t.duration*a-1,4),u=e*D+et;if(t.isMilestone){const w=d,y=e*D+D/2,k=document.createElementNS(i,"polygon"),L=st;k.setAttribute("points",`${w},${y-L} ${w+L},${y} ${w},${y+L} ${w-L},${y}`),k.setAttribute("fill",t.color??"#F39C12"),k.setAttribute("class",`task-bar milestone-bar${o?" bar-selected":""}`),k.dataset.id=t.id,this.addBarEvents(k,t),this.svg.append(k);return}const h=document.createElementNS(i,"g");h.setAttribute("class",`task-bar${c?" bar-critical":""}${r?" bar-summary":""}${o?" bar-selected":""}`),h.dataset.id=t.id;const b=document.createElementNS(i,"rect");if(P(b,{x:String(d),y:String(u),width:String(g),height:String(x),rx:r?"0":"3",fill:t.color??(c?"var(--bar-critical)":r?"var(--bar-summary)":"var(--bar-default)")}),h.append(b),t.progress>0){const w=document.createElementNS(i,"rect");P(w,{x:String(d),y:String(u),width:String(g*t.progress/100),height:String(x),rx:r?"0":"3",fill:"rgba(0,0,0,0.2)"}),h.append(w)}const p=document.createElementNS(i,"text");P(p,{x:String(d+4),y:String(u+x/2+4),class:"bar-label"}),p.textContent=t.title,h.append(p);const m=document.createElementNS(i,"rect");P(m,{x:String(d+g-6),y:String(u),width:"6",height:String(x),rx:"3",fill:"rgba(255,255,255,0.4)",class:"resize-handle",cursor:"ew-resize"}),m.dataset.id=t.id,m.dataset.mode="resize",h.append(m);const f=document.createElementNS(i,"circle");f.setAttribute("cx",String(d+g+8)),f.setAttribute("cy",String(u+x/2)),f.setAttribute("r","6"),f.setAttribute("fill","var(--accent)"),f.setAttribute("class","link-handle"),f.setAttribute("cursor","crosshair"),f.dataset.id=t.id,f.dataset.mode="link",h.append(f);const S=document.createElementNS(i,"title");S.textContent=`${t.title}
${t.startDate} â†’ ${t.endDate} (${t.duration}d)
${t.progress}% complete

Drag â—‹ to link to another task`,h.append(S),this.addBarEvents(h,t),this.svg.append(h)}addBarEvents(t,e){t.addEventListener("click",s=>{var a;s.stopPropagation(),this.selectedId=e.id,this.setSelected(e.id),(a=this.onSelectCallback)==null||a.call(this,e.id)}),t.addEventListener("mousedown",s=>{var n;const i=(n=s.target.dataset)==null?void 0:n.mode;if(i==="link")s.stopPropagation(),this.startLinkDraw(s,e);else{const c=i==="resize"?"resize":"move";this.startDrag(s,e,c)}})}renderArrow(t,e,s,a,i,n,c,r){var I,G;const o="http://www.w3.org/2000/svg",d=this.store.getCPM(),g=this.showCritical&&(((I=d.get(t.id))==null?void 0:I.isCritical)??!1)&&(((G=d.get(s.id))==null?void 0:G.isCritical)??!1),u=$(c,v(t.startDate))*r,h=t.duration*r,b=$(c,v(s.startDate))*r,p=s.duration*r,m=e*D+D/2,f=a*D+D/2;let S,w;switch(i){case"SS":S=u,w=b;break;case"FF":S=u+h,w=b+p;break;case"SF":S=u,w=b+p;break;default:S=u+h,w=b}const y=n*r;w+=y;const k=xt(S,m,w,f,Tt),L=document.createElementNS(o,"path");P(L,{d:k,stroke:g?"var(--dep-arrow-crit)":"var(--dep-arrow)","stroke-width":g?"2":"1.5",fill:"none","marker-end":g?"url(#arrow-crit)":"url(#arrow)",class:"dep-arrow"}),this.svg.append(L)}startLinkDraw(t,e){t.preventDefault(),this.linkDrawSrc=e.id;const s=C[this.zoom],a=v(this.store.getProject().startDate),n=this.store.getVisibleTasks().indexOf(e),c=$(a,v(e.startDate))*s,r=Math.max(e.duration*s-1,4),o=c+r+8,d=n*D+et+x/2,g="http://www.w3.org/2000/svg";this.linkLine=document.createElementNS(g,"line"),this.linkLine.setAttribute("x1",String(o)),this.linkLine.setAttribute("y1",String(d)),this.linkLine.setAttribute("x2",String(o)),this.linkLine.setAttribute("y2",String(d)),this.linkLine.setAttribute("stroke","var(--accent)"),this.linkLine.setAttribute("stroke-width","2"),this.linkLine.setAttribute("stroke-dasharray","5,3"),this.linkLine.setAttribute("marker-end","url(#arrow-draw)"),this.linkLine.setAttribute("class","link-draw-line"),this.svg.append(this.linkLine)}clientToSvg(t){const e=this.svg.getScreenCTM();if(!e)return null;const a=new DOMPoint(t.clientX,t.clientY).matrixTransform(e.inverse());return{x:a.x,y:a.y}}setupDrag(){document.addEventListener("mousemove",t=>this.onDragMove(t)),document.addEventListener("mouseup",t=>this.onDragEnd(t))}startDrag(t,e,s){t.preventDefault(),this.dragTask=e,this.dragMode=s,this.dragStartX=t.clientX,this.dragOrigStart=e.startDate,this.dragOrigDur=e.duration}onDragMove(t){if(this.linkDrawSrc&&this.linkLine){const c=this.clientToSvg(t);c&&(this.linkLine.setAttribute("x2",String(c.x)),this.linkLine.setAttribute("y2",String(c.y)));return}if(!this.dragTask)return;const e=C[this.zoom],s=t.clientX-this.dragStartX,a=Math.round(s/e),i=v(this.store.getProject().startDate),n=v(this.dragOrigStart);if(this.dragMode==="move"){const c=M(n,a);M(c,this.dragOrigDur-1);const r=this.svg.querySelector(`.task-bar[data-id="${this.dragTask.id}"]`);if(r){const o=$(i,c)*e;r.setAttribute("transform",`translate(${o-$(i,v(this.dragTask.startDate))*e},0)`)}}else{const c=Math.max(1,this.dragOrigDur+a),r=this.svg.querySelector(`.task-bar[data-id="${this.dragTask.id}"] rect`);r&&r.setAttribute("width",String(c*e-1))}}onDragEnd(t){var c,r;if(this.linkDrawSrc){(c=this.linkLine)==null||c.remove(),this.linkLine=null;const o=this.linkDrawSrc;this.linkDrawSrc=null;const d=document.elementFromPoint(t.clientX,t.clientY),g=d==null?void 0:d.closest(".task-bar"),u=(r=g==null?void 0:g.dataset)==null?void 0:r.id;if(u&&u!==o){const h=this.store.getTask(u),b=this.store.getTask(o);if(h&&b&&!h.predecessors.some(m=>m.taskId===o)){const m=rt(h.predecessors,this.store.getTasks()),f=m?`${m},${b.wbs}`:b.wbs;this.store.setPredecessorsFromString(u,f)}}return}if(!this.dragTask)return;const e=this.dragTask;this.dragTask=null;const s=C[this.zoom],a=this.svg.querySelector(`.task-bar[data-id="${e.id}"]`),i=a==null?void 0:a.getAttribute("transform");let n=0;if(i){const o=i.match(/translate\((-?[\d.]+)/);o&&(n=Math.round(parseFloat(o[1])/s)),a==null||a.removeAttribute("transform")}if(this.dragMode==="move"){const o=j(M(v(this.dragOrigStart),n));this.store.updateTask(e.id,{startDate:o})}else{const o=this.svg.querySelector(`.task-bar[data-id="${e.id}"] rect`);if(o){const d=parseFloat(o.getAttribute("width")??"0"),g=Math.max(1,Math.round(d/s));this.store.updateTask(e.id,{duration:g})}}}listenStore(){this.store.on(t=>{["task:add","task:update","task:delete","task:reorder","data:load","project:update"].includes(t.type)&&this.render()})}setSvgSize(t,e,s){t.setAttribute("width",String(Math.round(e))),t.setAttribute("height",String(Math.round(s))),t.setAttribute("viewBox",`0 0 ${Math.round(e)} ${Math.round(s)}`)}}function at(l){for(;l.lastChild;)l.removeChild(l.lastChild)}function P(l,t){Object.entries(t).forEach(([e,s])=>l.setAttribute(e,s))}function A(l,t,e,s,a,i="start"){const n=document.createElementNS(l,"text");return n.setAttribute("x",String(Math.round(e))),n.setAttribute("y",String(s)),n.setAttribute("class",a),n.setAttribute("text-anchor",i),n.textContent=t,n}function jt(l){const t=new Date(l.getFullYear(),0,4),e=new Date(t);return e.setDate(t.getDate()-(t.getDay()+6)%7),Math.ceil(((l.getTime()-e.getTime())/864e5+1)/7)}function xt(l,t,e,s,a,i){const n=s-t,c=e-l;if(c>a*2){const d=l+c/2;return`M${E(l)},${E(t)} L${E(d)},${E(t)} L${E(d)},${E(s)} L${E(e-5)},${E(s)}`}const r=l+a,o=n>0?t-10:t+10;return`M${E(l)},${E(t)} L${E(r)},${E(t)} L${E(r)},${E(o)} L${E(e-a)},${E(o)} L${E(e-a)},${E(s)} L${E(e-5)},${E(s)}`}function E(l){return Math.round(l)}function Ot(l){const t=new _("Settings â€” GitHub Sync"),e=N(),s=document.createElement("div");s.innerHTML=`
    <p class="settings-note">
      Data is saved to <strong>GitHub Pages directly</strong> via the GitHub Contents API.<br>
      Changes write to <code>gh-pages</code> branch and are live immediately â€” no server needed.
    </p>

    <h3 class="settings-section">GitHub Repository</h3>
    <div class="form-group">
      <label>Owner (username or org)</label>
      <input id="gs-owner" class="form-input" type="text" placeholder="alice" value="${(e==null?void 0:e.owner)??""}" />
    </div>
    <div class="form-group">
      <label>Repository name</label>
      <input id="gs-repo" class="form-input" type="text" placeholder="projmanager" value="${(e==null?void 0:e.repo)??""}" />
    </div>
    <div class="form-group">
      <label>Branch (where GitHub Pages is served from)</label>
      <input id="gs-branch" class="form-input" type="text" placeholder="gh-pages" value="${(e==null?void 0:e.branch)??"gh-pages"}" />
    </div>
    <div class="form-group">
      <label>Base path (repo name in URL, if project repo â€” leave blank for user/org pages)</label>
      <input id="gs-base" class="form-input" type="text" placeholder="projmanager" value="${(e==null?void 0:e.basePath)??""}" />
      <span class="field-hint">Current URL path: <code>${window.location.pathname}</code><br>
      Resolved data.json path: <code id="gs-preview">â€¦</code></span>
    </div>

    <h3 class="settings-section">Personal Access Token</h3>
    <div class="form-group">
      <label>GitHub PAT (needs <code>contents:write</code> permission)</label>
      <input id="gs-pat" class="form-input" type="password" placeholder="ghp_â€¦" value="${(e==null?void 0:e.pat)??""}" />
      <span class="field-hint">
        Create at <a href="https://github.com/settings/tokens/new?scopes=repo&description=projmanager" target="_blank" rel="noopener">github.com/settings/tokens</a>.
        Stored only in your browser â€” never committed.
      </span>
    </div>

    <div class="form-group" id="gs-status-row" style="display:none">
      <span id="gs-status"></span>
    </div>

    <div class="form-actions">
      <button class="btn btn-ghost" id="gs-test">Test connection</button>
      <button class="btn btn-ghost" id="gs-clear">Clear</button>
      <button class="btn btn-primary" id="gs-save">Save &amp; Sync</button>
    </div>

    <hr class="settings-hr" />

    <h3 class="settings-section">Project Dates</h3>
    <div class="form-row">
      <div class="form-group">
        <label>Start Date</label>
        <input id="gs-start" class="form-input" type="date" value="${l.getProject().startDate}" />
      </div>
      <div class="form-group">
        <label>End Date</label>
        <input id="gs-end" class="form-input" type="date" value="${l.getProject().endDate}" />
      </div>
    </div>
    <div class="form-group">
      <label>Description</label>
      <input id="gs-desc" class="form-input" type="text" value="${l.getProject().description}" />
    </div>
    <div class="form-actions">
      <button class="btn btn-primary" id="gs-proj-save">Save Project Settings</button>
    </div>
  `;const a=()=>{const c=s.querySelector("#gs-owner").value.trim(),r=s.querySelector("#gs-repo").value.trim();s.querySelector("#gs-branch").value.trim();const o=s.querySelector("#gs-base").value.trim();s.querySelector("#gs-pat").value.trim();const d=s.querySelector("#gs-preview");if(c&&r){const g={basePath:o};d.textContent=B(g)}else d.textContent="â€¦"};["gs-owner","gs-repo","gs-base"].forEach(c=>{s.querySelector(`#${c}`).addEventListener("input",a)}),a();const i=()=>({owner:s.querySelector("#gs-owner").value.trim(),repo:s.querySelector("#gs-repo").value.trim(),branch:s.querySelector("#gs-branch").value.trim()||"gh-pages",basePath:s.querySelector("#gs-base").value.trim(),pat:s.querySelector("#gs-pat").value.trim()}),n=(c,r)=>{const o=s.querySelector("#gs-status-row"),d=s.querySelector("#gs-status");o.style.display="",d.textContent=c,d.style.color=r?"var(--success)":"var(--danger)"};s.querySelector("#gs-test").addEventListener("click",async()=>{const c=i();if(!c.pat||!c.owner||!c.repo){n("Fill in owner, repo, and PAT first",!1);return}n("Testingâ€¦",!0);const r=await J(c);n(r??"OK: Connected successfully",!r)}),s.querySelector("#gs-clear").addEventListener("click",()=>{ht(),T("GitHub sync settings cleared","info"),t.close()}),s.querySelector("#gs-save").addEventListener("click",async()=>{const c=i();if(!c.pat||!c.owner||!c.repo){n("Fill in all required fields",!1);return}n("Verifyingâ€¦",!0);const r=await J(c);if(r){n(r,!1);return}ut(c),n("Settings saved. Syncingâ€¦",!0);const o=await l.syncNow();n(o?"OK: Data saved to GitHub Pages!":"Sync failed â€” check PAT permissions",o),o&&T("Synced to GitHub Pages","success")}),s.querySelector("#gs-proj-save").addEventListener("click",()=>{const c=s.querySelector("#gs-start").value,r=s.querySelector("#gs-end").value,o=s.querySelector("#gs-desc").value.trim();l.updateProject({startDate:c,endDate:r,description:o}),T("Project settings saved","success")}),t.setContent(s),t.open()}function At(){var t;const l=new URLSearchParams(window.location.search).get("p");return l||(((t=document.querySelector('meta[name="pm-project-id"]'))==null?void 0:t.content)??null)}async function Ct(){const l=new URLSearchParams(window.location.search).get("p"),t=At();if(!t)return;const e=new ft(t),s=!!l&&l!=="demo";await e.initialLoad(s),document.title=e.getProject().name;const a=document.getElementById("root");a.className="app-root";let i=e.getDefaultZoom();const n=new yt(e,{onAddTask(){var L;const y=(L=e.getVisibleTasks().at(-1))==null?void 0:L.id,k=e.addTask(y);c.setSelected(k.id),r.setSelected(k.id)},onAddMilestone(){w()},onZoomChange(y){i=y,r.setZoom(y)},onToggleCriticalPath(y){r.setShowCritical(y)},onScrollToToday(){r.scrollToToday()},onOpenSettings(){Ot(e)}}),c=new Pt(e),r=new Mt(e);c.onSelect(y=>r.setSelected(y)),r.onSelect(y=>c.setSelected(y));const o=document.createElement("div");o.className="content-area";const d=document.createElement("div");d.id="left-panel",d.className="left-panel",d.append(c.getElement());const g=document.createElement("div");g.className="panel-divider",g.title="Drag to resize";const u=document.createElement("div");u.id="right-panel",u.className="right-panel",u.append(r.getElement()),o.append(d,g,u),a.append(n.getElement(),o);const h=d.querySelector(".task-table-wrap"),b=u.querySelector(".gantt-body-wrap");let p=!1;h.addEventListener("scroll",()=>{p||(p=!0,b.scrollTop=h.scrollTop,p=!1)}),b.addEventListener("scroll",()=>{p||(p=!0,h.scrollTop=b.scrollTop,p=!1)});let m=!1,f=0,S=0;g.addEventListener("mousedown",y=>{m=!0,f=y.clientX,S=d.getBoundingClientRect().width,document.body.style.cursor="col-resize",document.body.style.userSelect="none"}),document.addEventListener("mousemove",y=>{if(!m)return;const k=Math.max(200,Math.min(S+(y.clientX-f),window.innerWidth-300));d.style.width=`${k}px`,d.style.flex="none"}),document.addEventListener("mouseup",()=>{m&&(m=!1,document.body.style.cursor="",document.body.style.userSelect="")}),e.on(y=>{y.type==="project:update"&&(n.syncProjectName(),document.title=e.getProject().name),y.type==="data:load"&&(n.syncProjectName(),document.title=e.getProject().name,r.setZoom(i))});function w(){const y=new _("Add Milestone"),k=document.createElement("div");k.innerHTML=`
      <div class="form-group">
        <label>Title</label>
        <input id="ms-title" class="form-input" type="text" placeholder="Milestone name" />
      </div>
      <div class="form-group">
        <label>Date</label>
        <input id="ms-date" class="form-input" type="date" value="${R()}" />
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" id="ms-ok">Add</button>
        <button class="btn btn-ghost" id="ms-cancel">Cancel</button>
      </div>
    `,k.querySelector("#ms-ok").addEventListener("click",()=>{const L=k.querySelector("#ms-title").value.trim(),I=k.querySelector("#ms-date").value;if(!L){T("Enter a title","error");return}e.addMilestone(L,I),y.close(),T("Milestone added","success")}),k.querySelector("#ms-cancel").addEventListener("click",()=>y.close()),y.setContent(k),y.open(),k.querySelector("#ms-title").focus()}r.setZoom(i),n.setZoom(i)}Ct();
